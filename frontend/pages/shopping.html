<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tech Turf - Futuristic Technology Marketplace</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="/src/css/pages/style.css">
    <link rel="stylesheet" href="/src/css/pages/shop-styles.css">
    <script src="/src/js/features/shop-logic.js"></script>
    <script src="/src/js/core/layout.js" defer></script>
</head>

<body data-page="Shop" class="shop-branding">
    <div id="header-container"></div>

    <section class="shop-hero">
        <div class="shop-container reveal-hidden">
            <h1 class="reveal-hidden">Advanced Tech <br>Marketplace</h1>
            <p class="text-gray-400 text-lg mb-10 tracking-[0.3em] uppercase reveal-hidden">Strategic Hardware & Global
                Engineering Nodes</p>
            <div class="reveal-hidden" style="transition-delay: 0.2s;">
                <button class="cta-btn magnetic-btn"
                    onclick="document.getElementById('product-grid-start').scrollIntoView({behavior: 'smooth'})">
                    <span>Initialize Supply Chain</span>
                    <i data-lucide="arrow-down" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </section>

    <section class="category-strip" id="product-grid-start">
        <div class="shop-container">
            <div class="category-list">
                <button class="category-btn active" data-category="all">All Modules</button>
                <button class="category-btn" data-category="Tech Turf">Tech Turf</button>
                <button class="category-btn" data-category="Quinta">Quinta</button>
                <button class="category-btn" data-category="Trend Hive">Trend Hive</button>
                <button class="category-btn" data-category="Click Sphere">Click Sphere</button>
            </div>
        </div>
    </section>

    <section class="featured-section">
        <div class="shop-container">
            <h2 class="section-title reveal-hidden">High-Performance <span class="text-[#d2670e]">Assets</span></h2>
            <div id="featured-grid" class="featured-grid reveal-hidden"></div>
        </div>
    </section>

    <section class="product-section">
        <div class="shop-container">
            <h2 class="section-title reveal-hidden">Inventory <span class="text-[#d2670e]">Manifest</span></h2>

            <div class="mb-8 grid grid-cols-1 lg:grid-cols-4 gap-4">
                <div class="lg:col-span-2">
                    <label class="block text-xs text-gray-400 uppercase tracking-widest mb-2">Search</label>
                    <input id="search-input" type="text" placeholder="Search products"
                        class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:bg-white/10 transition-all outline-none">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 uppercase tracking-widest mb-2">Sort</label>
                    <select id="sort-select"
                        class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:bg-white/10 transition-all outline-none">
                        <option value="featured">Featured</option>
                        <option value="price-asc">Price: Low to High</option>
                        <option value="price-desc">Price: High to Low</option>
                        <option value="newest">Newest</option>
                        <option value="name-asc">Name: A to Z</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 uppercase tracking-widest mb-2">Price Range</label>
                    <div class="flex gap-2">
                        <input id="price-min" type="number" min="0" placeholder="Min"
                            class="w-1/2 bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:bg-white/10 transition-all outline-none">
                        <input id="price-max" type="number" min="0" placeholder="Max"
                            class="w-1/2 bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:bg-white/10 transition-all outline-none">
                    </div>
                </div>
            </div>

            <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-xs text-gray-400 uppercase tracking-widest mb-2">Brand</label>
                    <select id="brand-select"
                        class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:bg-white/10 transition-all outline-none">
                        <option value="all">All Brands</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 uppercase tracking-widest mb-2">Min Rating</label>
                    <select id="rating-min"
                        class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:bg-white/10 transition-all outline-none">
                        <option value="0">All Ratings</option>
                        <option value="4">4+ Stars</option>
                        <option value="3">3+ Stars</option>
                        <option value="2">2+ Stars</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 uppercase tracking-widest mb-2">Delivery (Days)</label>
                    <select id="delivery-max"
                        class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:bg-white/10 transition-all outline-none">
                        <option value="0">Any</option>
                        <option value="1">1 Day</option>
                        <option value="2">2 Days</option>
                        <option value="3">3 Days</option>
                        <option value="5">5 Days</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <label class="inline-flex items-center gap-2 text-xs text-gray-400 uppercase tracking-widest">
                        <input id="in-stock-only" type="checkbox" class="accent-orange-500">
                        In stock only
                    </label>
                </div>
            </div>

            <div class="mb-10 flex flex-wrap items-center gap-4">
                <label class="inline-flex items-center gap-2 text-xs text-gray-400 uppercase tracking-widest">
                    <input id="wishlist-only" type="checkbox" class="accent-orange-500">
                    Wishlist only
                </label>
                <button id="clear-filters"
                    class="px-4 py-2 bg-white/5 border border-white/10 rounded-xl text-xs text-white/70 uppercase tracking-widest hover:bg-white/10 transition-all">
                    Clear Filters
                </button>
            </div>

            <div id="compare-bar" class="mb-10 hidden items-center justify-between p-4 bg-white/5 border border-white/10 rounded-2xl">
                <span id="compare-count" class="text-xs text-white/70 uppercase tracking-widest">Compare (0)</span>
                <button id="compare-go"
                    class="px-4 py-2 bg-white/10 border border-white/10 rounded-xl text-xs text-white/80 uppercase tracking-widest hover:bg-white/20 transition-all">
                    Compare Now
                </button>
            </div>

            <div id="recent-section" class="mb-12 hidden">
                <h3 class="text-xl font-black text-white uppercase tracking-widest mb-6">Recently Viewed</h3>
                <div id="recent-grid" class="product-grid"></div>
            </div>

            <div id="products-grid" class="product-grid"></div>
            <div id="pagination" class="mt-10 flex items-center justify-between text-xs text-white/60 uppercase tracking-widest"></div>
        </div>
    </section>

    <section class="status-strip">
        <div class="shop-container">
            <div class="status-item">
                <div class="status-dot"></div>
                <span>Server Status: Online</span>
            </div>
            <div class="status-item">
                <i data-lucide="package" class="w-4 h-4"></i>
                <span id="product-count">Scanning Inventory...</span>
            </div>
            <div class="status-item">
                <i data-lucide="shield-check" class="w-4 h-4 text-green-500"></i>
                <span>Secure SSL Encryption</span>
            </div>
            <div class="status-item">
                <i data-lucide="cpu" class="w-4 h-4"></i>
                <span>Tech Turf OS v6.0</span>
            </div>
        </div>
    </section>

    <div id="footer-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const productsGrid = document.getElementById('products-grid');
            const featuredGrid = document.getElementById('featured-grid');
            const productCount = document.getElementById('product-count');
            const searchInput = document.getElementById('search-input');
            const sortSelect = document.getElementById('sort-select');
            const priceMinInput = document.getElementById('price-min');
            const priceMaxInput = document.getElementById('price-max');
            const brandSelect = document.getElementById('brand-select');
            const ratingMinSelect = document.getElementById('rating-min');
            const deliveryMaxSelect = document.getElementById('delivery-max');
            const inStockOnlyInput = document.getElementById('in-stock-only');
            const wishlistOnlyInput = document.getElementById('wishlist-only');
            const clearFiltersBtn = document.getElementById('clear-filters');
            const pagination = document.getElementById('pagination');
            const compareBar = document.getElementById('compare-bar');
            const compareCount = document.getElementById('compare-count');
            const compareGo = document.getElementById('compare-go');
            const recentSection = document.getElementById('recent-section');
            const recentGrid = document.getElementById('recent-grid');

            if (productCount) productCount.textContent = 'Loading Inventory...';

            const allProducts = await window.fetchProducts();

            if (productCount) productCount.textContent = `${allProducts.length} Units Available`;
            if (allProducts.length === 0) {
                productsGrid.innerHTML = '<p class="text-white text-center col-span-full">No products found.</p>';
                return;
            }

            const state = {
                products: allProducts,
                filtered: allProducts,
                currentPage: 1,
                itemsPerPage: 12,
                search: '',
                sort: 'featured',
                priceMin: null,
                priceMax: null,
                category: 'all',
                brand: 'all',
                ratingMin: 0,
                deliveryMax: 0,
                inStockOnly: false,
                wishlistOnly: false,
                wishlist: new Set(JSON.parse(localStorage.getItem('tt_wishlist') || '[]')),
                compare: new Set(JSON.parse(localStorage.getItem('tt_compare') || '[]')),
            };

            const productMap = new Map();
            allProducts.forEach((product) => {
                const productId = product._id || product.id;
                if (productId) productMap.set(String(productId), product);
            });

            const getStock = (product) => Number(product.stock || product.countInStock || 0);

            const renderStars = (rating) => {
                const rounded = Math.round(Number(rating || 0));
                const stars = [];
                for (let i = 1; i <= 5; i += 1) {
                    stars.push(`<span class="${i <= rounded ? 'text-yellow-400' : 'text-white/20'}">★</span>`);
                }
                return stars.join('');
            };

            const renderProduct = (product) => {
                const stockCount = getStock(product);
                const productId = product._id || product.id;
                const isWishlisted = productId ? state.wishlist.has(String(productId)) : false;
                const isCompared = productId ? state.compare.has(String(productId)) : false;
                const wishlistClass = isWishlisted ? 'text-red-400 border-red-400/40' : 'text-white/50 border-white/10';
                const compareClass = isCompared ? 'text-blue-400 border-blue-400/40' : 'text-white/50 border-white/10';

                return `
                <div class="product-card group relative bg-white/5 border border-white/10 rounded-2xl overflow-hidden hover:border-[#d2670e]/50 transition-all duration-300" data-category="${product.branch || product.category || 'Tech Turf'}" data-product-id="${productId || ''}">
                    <div class="absolute top-3 right-3 flex gap-2">
                        <button class="compare-btn w-10 h-10 rounded-full border ${compareClass} bg-black/40 backdrop-blur flex items-center justify-center transition-all" data-product-id="${productId || ''}" aria-label="Toggle compare">
                            <i data-lucide="columns" class="w-4 h-4"></i>
                        </button>
                        <button class="wishlist-btn w-10 h-10 rounded-full border ${wishlistClass} bg-black/40 backdrop-blur flex items-center justify-center transition-all" data-product-id="${productId || ''}" aria-label="Toggle wishlist">
                            <i data-lucide="heart" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="aspect-square bg-black/20 relative overflow-hidden">
                        <img src="${product.imageUrl || (product.images && product.images[0]) || 'https://via.placeholder.com/300'}" alt="${product.name}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end justify-center p-6">
                            <button
                                ${stockCount > 0 ? '' : 'disabled'}
                                class="add-to-cart-btn ${stockCount > 0 ? 'bg-[#d2670e] hover:bg-[#b0550b] cursor-pointer' : 'bg-white/10 text-white/40 cursor-not-allowed'} text-white px-6 py-3 rounded-full font-bold uppercase text-xs tracking-widest transition-colors w-full"
                                data-product-id="${productId || ''}">
                                ${stockCount > 0 ? 'Add to Cart' : 'Out of Stock'}
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-white font-bold text-lg leading-tight group-hover:text-[#d2670e] transition-colors">${product.name}</h3>
                            <span class="text-[#d2670e] font-mono font-bold">₹${product.price}</span>
                        </div>
                        <p class="text-gray-400 text-sm line-clamp-2 mb-4">${product.description}</p>
                        <div class="flex items-center gap-2 text-xs text-gray-500 font-mono mb-2">
                            <span class="w-2 h-2 rounded-full ${stockCount > 0 ? 'bg-green-500' : 'bg-red-500'}"></span>
                            ${stockCount > 0 ? `In Stock (${stockCount})` : 'Out of Stock'}
                        </div>
                        <div class="flex items-center justify-between text-xs text-white/50 uppercase tracking-widest mb-3">
                            <span>ETA ${Number(product.deliveryEtaDays || 3)}d</span>
                            <span>${product.brand || 'Tech Turf'}</span>
                        </div>
                        <div class="flex items-center justify-between text-xs mb-4">
                            <span class="text-yellow-400">${renderStars(product.ratingAvg || 0)}</span>
                            <span class="text-white/40">${Number(product.ratingCount || 0)} reviews</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <input type="number" min="1" value="1" ${stockCount > 0 ? '' : 'disabled'}
                                class="qty-input w-20 bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-white text-xs focus:bg-white/10 outline-none"
                                data-product-id="${productId || ''}">
                            <button class="quick-add-btn flex-1 px-4 py-2 rounded-xl text-xs font-black uppercase tracking-widest ${stockCount > 0 ? 'bg-white/10 hover:bg-white/20 text-white' : 'bg-white/5 text-white/30 cursor-not-allowed'}"
                                ${stockCount > 0 ? '' : 'disabled'} data-product-id="${productId || ''}">
                                Quick Add
                            </button>
                        </div>
                    </div>
                </div>
                `;
            };

            const renderPagination = () => {
                const totalPages = Math.max(1, Math.ceil(state.filtered.length / state.itemsPerPage));
                if (state.currentPage > totalPages) state.currentPage = totalPages;

                const pageLabel = `Page ${state.currentPage} of ${totalPages}`;
                const canPrev = state.currentPage > 1;
                const canNext = state.currentPage < totalPages;

                pagination.innerHTML = `
                    <button id="page-prev" class="px-4 py-2 rounded-xl border border-white/10 ${canPrev ? 'text-white hover:bg-white/10' : 'text-white/30 cursor-not-allowed'}" ${canPrev ? '' : 'disabled'}>
                        Previous
                    </button>
                    <span>${pageLabel}</span>
                    <button id="page-next" class="px-4 py-2 rounded-xl border border-white/10 ${canNext ? 'text-white hover:bg-white/10' : 'text-white/30 cursor-not-allowed'}" ${canNext ? '' : 'disabled'}>
                        Next
                    </button>
                `;

                const prevBtn = document.getElementById('page-prev');
                const nextBtn = document.getElementById('page-next');
                if (prevBtn) prevBtn.addEventListener('click', () => { state.currentPage -= 1; render(); });
                if (nextBtn) nextBtn.addEventListener('click', () => { state.currentPage += 1; render(); });
            };

            const updateCompareBar = () => {
                const count = state.compare.size;
                if (count === 0) {
                    compareBar.classList.add('hidden');
                } else {
                    compareBar.classList.remove('hidden');
                }
                compareCount.textContent = `Compare (${count})`;
                compareGo.disabled = count < 2;
                compareGo.classList.toggle('cursor-not-allowed', count < 2);
            };

            const applyFilters = () => {
                const search = state.search.trim().toLowerCase();

                state.filtered = state.products.filter((product) => {
                    const name = (product.name || '').toLowerCase();
                    const desc = (product.description || '').toLowerCase();
                    const matchesSearch = !search || name.includes(search) || desc.includes(search);

                    const category = product.branch || product.category || 'Tech Turf';
                    const matchesCategory = state.category === 'all' || category === state.category;

                    const price = Number(product.price || 0);
                    const minOk = state.priceMin === null || price >= state.priceMin;
                    const maxOk = state.priceMax === null || price <= state.priceMax;

                    const productId = product._id || product.id;
                    const matchesWishlist = !state.wishlistOnly || (productId && state.wishlist.has(String(productId)));

                    const brand = product.brand || 'Tech Turf';
                    const matchesBrand = state.brand === 'all' || brand === state.brand;

                    const rating = Number(product.ratingAvg || 0);
                    const matchesRating = rating >= state.ratingMin;

                    const deliveryDays = Number(product.deliveryEtaDays || 3);
                    const matchesDelivery = state.deliveryMax === 0 || deliveryDays <= state.deliveryMax;

                    const matchesStock = !state.inStockOnly || getStock(product) > 0;

                    return matchesSearch && matchesCategory && minOk && maxOk && matchesWishlist && matchesBrand && matchesRating && matchesDelivery && matchesStock;
                });

                if (state.sort === 'price-asc') {
                    state.filtered.sort((a, b) => Number(a.price || 0) - Number(b.price || 0));
                } else if (state.sort === 'price-desc') {
                    state.filtered.sort((a, b) => Number(b.price || 0) - Number(a.price || 0));
                } else if (state.sort === 'newest') {
                    state.filtered.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                } else if (state.sort === 'name-asc') {
                    state.filtered.sort((a, b) => String(a.name || '').localeCompare(String(b.name || '')));
                }
            };

            const renderRecent = () => {
                const recentIds = JSON.parse(localStorage.getItem('tt_recent') || '[]');
                const recentProducts = recentIds
                    .map((id) => productMap.get(String(id)))
                    .filter(Boolean)
                    .slice(0, 6);

                if (recentProducts.length === 0) {
                    recentSection.classList.add('hidden');
                    return;
                }

                recentSection.classList.remove('hidden');
                recentGrid.innerHTML = recentProducts.map(renderProduct).join('');
            };

            const render = () => {
                applyFilters();

                const total = state.filtered.length;
                if (productCount) productCount.textContent = `${total} Units Available`;

                const start = (state.currentPage - 1) * state.itemsPerPage;
                const end = start + state.itemsPerPage;
                const pageItems = state.filtered.slice(start, end);

                productsGrid.innerHTML = pageItems.length
                    ? pageItems.map(renderProduct).join('')
                    : '<p class="text-white text-center col-span-full">No products found.</p>';

                if (featuredGrid) {
                    featuredGrid.innerHTML = state.products.slice(0, 3).map(renderProduct).join('');
                }

                renderPagination();
                renderRecent();
                updateCompareBar();

                if (window.lucide) lucide.createIcons();
            };

            const addProductToCart = (productId, qty) => {
                const product = productMap.get(String(productId));
                if (!product) return;
                const quantity = Math.max(1, Number(qty || 1));
                for (let i = 0; i < quantity; i += 1) {
                    window.addToCart(product);
                }
            };

            productsGrid.addEventListener('click', (event) => {
                const target = event.target.closest('button');
                if (!target) return;

                const productId = target.dataset.productId;
                if (!productId) return;

                if (target.classList.contains('add-to-cart-btn')) {
                    addProductToCart(productId, 1);
                }

                if (target.classList.contains('quick-add-btn')) {
                    const qtyInput = productsGrid.querySelector(`.qty-input[data-product-id="${productId}"]`);
                    addProductToCart(productId, qtyInput ? qtyInput.value : 1);
                }

                if (target.classList.contains('wishlist-btn')) {
                    const key = String(productId);
                    if (state.wishlist.has(key)) {
                        state.wishlist.delete(key);
                    } else {
                        state.wishlist.add(key);
                    }
                    localStorage.setItem('tt_wishlist', JSON.stringify(Array.from(state.wishlist)));
                    if (window.updateWishlistDisplay) window.updateWishlistDisplay();
                    render();
                }

                if (target.classList.contains('compare-btn')) {
                    const key = String(productId);
                    if (state.compare.has(key)) {
                        state.compare.delete(key);
                    } else {
                        state.compare.add(key);
                    }
                    localStorage.setItem('tt_compare', JSON.stringify(Array.from(state.compare)));
                    updateCompareBar();
                    render();
                }
            });

            const handleFilterChange = () => {
                state.search = searchInput.value || '';
                state.sort = sortSelect.value || 'featured';
                state.priceMin = priceMinInput.value ? Number(priceMinInput.value) : null;
                state.priceMax = priceMaxInput.value ? Number(priceMaxInput.value) : null;
                state.brand = brandSelect.value || 'all';
                state.ratingMin = Number(ratingMinSelect.value || 0);
                state.deliveryMax = Number(deliveryMaxSelect.value || 0);
                state.inStockOnly = inStockOnlyInput.checked;
                state.wishlistOnly = wishlistOnlyInput.checked;
                state.currentPage = 1;
                render();
            };

            searchInput.addEventListener('input', handleFilterChange);
            sortSelect.addEventListener('change', handleFilterChange);
            priceMinInput.addEventListener('input', handleFilterChange);
            priceMaxInput.addEventListener('input', handleFilterChange);
            brandSelect.addEventListener('change', handleFilterChange);
            ratingMinSelect.addEventListener('change', handleFilterChange);
            deliveryMaxSelect.addEventListener('change', handleFilterChange);
            inStockOnlyInput.addEventListener('change', handleFilterChange);
            wishlistOnlyInput.addEventListener('change', handleFilterChange);

            clearFiltersBtn.addEventListener('click', () => {
                searchInput.value = '';
                sortSelect.value = 'featured';
                priceMinInput.value = '';
                priceMaxInput.value = '';
                brandSelect.value = 'all';
                ratingMinSelect.value = '0';
                deliveryMaxSelect.value = '0';
                inStockOnlyInput.checked = false;
                wishlistOnlyInput.checked = false;
                state.category = 'all';
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('.category-btn[data-category="all"]').classList.add('active');
                handleFilterChange();
            });

            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.category = btn.dataset.category;
                    state.currentPage = 1;
                    render();
                });
            });

            compareGo.addEventListener('click', () => {
                const ids = Array.from(state.compare);
                if (ids.length < 2) {
                    window.showMessage('info', 'Select at least two products to compare.');
                    return;
                }
                window.location.href = `compare.html?ids=${ids.join(',')}`;
            });

            const brands = Array.from(new Set(allProducts.map(p => p.brand || 'Tech Turf'))).sort();
            brands.forEach((brand) => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandSelect.appendChild(option);
            });

            render();
        });
    </script>
</body>

</html>
