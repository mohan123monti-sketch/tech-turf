<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tech Turf - Secure Checkout</title>

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Styles & Scripts -->
    <link rel="stylesheet" href="/src/css/pages/style.css">
    <link rel="stylesheet" href="/src/css/pages/shop-styles.css">
    <script src="/src/js/features/shop-logic.js" defer></script>
    <script src="/src/js/core/layout.js" defer></script>
</head>

<body data-page="Shop" class="shop-branding">

    <!-- Header -->
    <div id="header-container"></div>

    <main class="relative z-10 py-32 px-4 shadow-inner">
        <div class="shop-container">
            <header class="mb-20">
                <h1 class="text-6xl font-black uppercase text-white tracking-tighter">Secure <span
                        class="text-[#d2670e]">Checkout</span></h1>
                <p class="text-gray-500 font-bold text-xs uppercase tracking-[0.4em] mt-2">Finalize Your Acquisition
                    Request</p>
            </header>

            <form id="checkout-form" class="grid grid-cols-1 lg:grid-cols-12 gap-12">

                <!-- Billing & Shipping Details -->
                <div class="lg:col-span-8 space-y-8">
                    <div class="bg-white/5 border border-white/5 p-10 rounded-[40px] reveal-hidden">
                        <div class="flex items-center gap-4 mb-10 border-b border-white/5 pb-6">
                            <i data-lucide="truck" class="text-[#d2670e]"></i>
                            <h2 class="text-2xl font-black uppercase text-white">Shipping Details</h2>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="md:col-span-2 space-y-4">
                                <label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Saved
                                    Addresses</label>
                                <select id="address-book"
                                    class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-white focus:border-[#d2670e] outline-none transition-all">
                                    <option value="">Select a saved address</option>
                                </select>
                            </div>
                            <div class="space-y-4">
                                <label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">First
                                    Name</label>
                                <input type="text" id="first-name" required
                                    class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-white focus:border-[#d2670e] outline-none transition-all">
                            </div>
                            <div class="space-y-4">
                                <label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Last
                                    Name</label>
                                <input type="text" id="last-name" required
                                    class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-white focus:border-[#d2670e] outline-none transition-all">
                            </div>
                            <div class="md:col-span-2 space-y-4">
                                <label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Shipping
                                    Address</label>
                                <input type="text" id="address" required
                                    class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-white focus:border-[#d2670e] outline-none transition-all">
                            </div>
                            <div class="space-y-4">
                                <label
                                    class="text-[10px] text-gray-500 font-black uppercase tracking-widest">City</label>
                                <input type="text" id="city" required
                                    class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-white focus:border-[#d2670e] outline-none transition-all">
                            </div>
                            <div class="space-y-4">
                                <label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">State</label>
                                <input type="text" id="state"
                                    class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-white focus:border-[#d2670e] outline-none transition-all">
                            </div>
                            <div class="space-y-4">
                                <label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Postal
                                    Code</label>
                                <input type="text" id="zip" required
                                    class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-white focus:border-[#d2670e] outline-none transition-all">
                            </div>
                            <div class="space-y-4">
                                <label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Phone</label>
                                <input type="text" id="phone"
                                    class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-white focus:border-[#d2670e] outline-none transition-all">
                            </div>
                            <div class="space-y-4">
                                <label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Company</label>
                                <input type="text" id="company"
                                    class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-white focus:border-[#d2670e] outline-none transition-all">
                            </div>
                            <div class="space-y-4">
                                <label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">GSTIN</label>
                                <input type="text" id="gstin"
                                    class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-white focus:border-[#d2670e] outline-none transition-all">
                            </div>
                            <div class="md:col-span-2 space-y-4">
                                <label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Delivery Slot</label>
                                <select id="delivery-slot"
                                    class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-white focus:border-[#d2670e] outline-none transition-all">
                                    <option value="Morning (9am-12pm)">Morning (9am-12pm)</option>
                                    <option value="Afternoon (12pm-4pm)">Afternoon (12pm-4pm)</option>
                                    <option value="Evening (4pm-8pm)">Evening (4pm-8pm)</option>
                                </select>
                            </div>
                            <div class="md:col-span-2 space-y-4">
                                <label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Order Notes</label>
                                <textarea id="order-notes" rows="3"
                                    class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-white focus:border-[#d2670e] outline-none transition-all"></textarea>
                            </div>
                            <div class="md:col-span-2 space-y-4">
                                <label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Gift Message</label>
                                <textarea id="gift-message" rows="2"
                                    class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-white focus:border-[#d2670e] outline-none transition-all"></textarea>
                            </div>
                            <div class="md:col-span-2 flex items-center gap-3 text-xs text-gray-400 uppercase tracking-widest">
                                <input type="checkbox" id="save-address" class="accent-orange-500">
                                Save this address
                            </div>
                        </div>
                    </div>

                    <div class="bg-white/5 border border-white/5 p-10 rounded-[40px] reveal-hidden">
                        <div class="flex items-center gap-4 mb-10 border-b border-white/5 pb-6">
                            <i data-lucide="credit-card" class="text-[#d2670e]"></i>
                            <h2 class="text-2xl font-black uppercase text-white">Payment Method</h2>
                        </div>

                        <div
                            class="p-8 border-2 border-[#d2670e] rounded-[30px] bg-orange-500/5 flex items-center justify-between">
                            <div class="flex items-center gap-6">
                                <div class="w-12 h-12 bg-orange-500/10 rounded-full flex items-center justify-center">
                                    <i data-lucide="hand-coins" class="text-[#d2670e]"></i>
                                </div>
                                <div>
                                    <h4 class="text-white font-black uppercase text-sm">Cash on Delivery</h4>
                                    <p class="text-gray-500 text-[10px] uppercase font-bold tracking-widest mt-1">
                                        Payment upon physical delivery</p>
                                </div>
                            </div>
                            <div class="w-6 h-6 rounded-full border-2 border-[#d2670e] p-1">
                                <div class="w-full h-full bg-[#d2670e] rounded-full"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Panel -->
                <div class="lg:col-span-4">
                    <div class="bg-white/5 border border-white/10 p-10 rounded-[40px] sticky top-32 shadow-2xl">
                        <h2 class="text-2xl font-black uppercase text-white mb-8">Order Summary</h2>

                        <div id="order-items-list"
                            class="space-y-4 mb-10 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                            <!-- Injected via JS -->
                        </div>

                        <div class="space-y-6 mb-10 pb-8 border-b border-white/5">
                            <div class="flex items-center gap-2">
                                <input id="promo-code" type="text" placeholder="Promo code"
                                    class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:bg-white/10 transition-all outline-none">
                                <button id="apply-promo" type="button"
                                    class="px-4 py-3 bg-white/10 border border-white/10 rounded-xl text-xs text-white/80 uppercase tracking-widest hover:bg-white/20 transition-all">
                                    Apply
                                </button>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-400 font-bold uppercase tracking-widest text-[10px]">GST
                                    (18%)</span>
                                <span id="summary-tax" class="text-white font-black text-lg">₹0.00</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-400 font-bold uppercase tracking-widest text-[10px]">Discount</span>
                                <span id="summary-discount" class="text-white font-black text-lg">₹0.00</span>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mb-10">
                            <span class="text-gray-300 font-black uppercase tracking-widest text-xs">Final Total</span>
                            <span id="summary-total"
                                class="text-white font-black text-4xl tracking-tighter">₹0.00</span>
                        </div>

                        <button id="place-order-btn" type="submit"
                            class="cta-btn magnetic-btn w-full justify-center">Authorize Checkout</button>
                    </div>
                </div>

            </form>
        </div>
    </main>

    <!-- Success Modal -->
    <div id="success-modal"
        class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-xl hidden p-4">
        <div class="bg-[#0b1537] max-w-md w-full p-12 rounded-[40px] text-center border border-white/10 shadow-3xl">
            <div
                class="w-24 h-24 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-8 border border-green-500/20">
                <i data-lucide="check" class="text-green-500 w-12 h-12"></i>
            </div>
            <h3 class="text-3xl font-black text-white mb-4 uppercase tracking-tighter">Order Success</h3>
            <p class="text-gray-400 mb-10 text-sm">Your acquisition has been logged. Our dispatch team is preparing your
                hardware.</p>
            <a href="/index.html" class="cta-btn magnetic-btn w-full justify-center">Return to Command</a>
        </div>
    </div>

    <div id="footer-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('checkout-form');
            const cart = window.getCart ? window.getCart() : [];
            const addressBook = document.getElementById('address-book');
            const saveAddress = document.getElementById('save-address');
            const promoInput = document.getElementById('promo-code');
            const applyPromoBtn = document.getElementById('apply-promo');
            const summaryDiscount = document.getElementById('summary-discount');

            let discountAmount = 0;
            let activePromoCode = '';

            if (cart.length === 0) {
                window.location.href = 'shopping.html';
                return;
            }

            function initSummary() {
                const list = document.getElementById('order-items-list');
                let subtotal = 0;

                cart.forEach(item => {
                    const qty = item.qty || item.quantity || 1;
                    subtotal += (Number(item.price) || 0) * qty;
                    const div = document.createElement('div');
                    div.className = 'flex justify-between gap-4 py-2 border-b border-white/5';
                    div.innerHTML = `
                        <span class="text-xs text-gray-400 font-bold uppercase">${item.name} x${qty}</span>
                        <span class="text-xs text-white font-black shrink-0">₹${(Number(item.price) || 0).toFixed(2)}</span>
                    `;
                    list.appendChild(div);
                });

                const tax = subtotal * 0.18;
                const total = subtotal + tax - discountAmount;
                document.getElementById('summary-tax').textContent = `₹${tax.toFixed(2)}`;
                if (summaryDiscount) summaryDiscount.textContent = `₹${discountAmount.toFixed(2)}`;
                document.getElementById('summary-total').textContent = `₹${total.toFixed(2)}`;
            }

            async function loadAddresses() {
                try {
                    const response = await fetch(`${window.API_BASE_URL}/users/addresses`, {
                        headers: { 'Authorization': `Bearer ${window.getAuthToken()}` }
                    });
                    if (!response.ok) return;
                    const payload = await response.json();
                    const addresses = payload.addresses || [];
                    addressBook.innerHTML = '<option value="">Select a saved address</option>';
                    addresses.forEach((addr) => {
                        const option = document.createElement('option');
                        option.value = addr._id;
                        option.textContent = `${addr.label || 'Address'} - ${addr.address}, ${addr.city}`;
                        option.dataset.address = JSON.stringify(addr);
                        addressBook.appendChild(option);
                    });
                    const defaultAddr = addresses.find((addr) => addr.isDefault);
                    if (defaultAddr) {
                        addressBook.value = defaultAddr._id;
                        fillAddress(defaultAddr);
                    }
                } catch (error) {
                    console.error('Failed to load addresses:', error);
                }
            }

            function fillAddress(addr) {
                document.getElementById('address').value = addr.address || '';
                document.getElementById('city').value = addr.city || '';
                document.getElementById('state').value = addr.state || '';
                document.getElementById('zip').value = addr.postalCode || '';
                document.getElementById('phone').value = addr.phone || '';
                document.getElementById('company').value = addr.company || '';
                document.getElementById('gstin').value = addr.gstin || '';
            }

            addressBook.addEventListener('change', () => {
                const selected = addressBook.selectedOptions[0];
                if (!selected || !selected.dataset.address) return;
                const addr = JSON.parse(selected.dataset.address);
                fillAddress(addr);
            });

            applyPromoBtn.addEventListener('click', async () => {
                const code = promoInput.value.trim();
                if (!code) return;
                const subtotal = cart.reduce((sum, item) => sum + (Number(item.price) || 0) * (item.qty || item.quantity || 1), 0);
                try {
                    const response = await fetch(`${window.API_BASE_URL}/promos/validate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code, orderTotal: subtotal })
                    });
                    const payload = await response.json();
                    if (!response.ok) {
                        discountAmount = 0;
                        activePromoCode = '';
                        window.showMessage('error', payload.message || 'Invalid promo code');
                        initSummary();
                        return;
                    }
                    discountAmount = Number(payload.discount || 0);
                    activePromoCode = payload.code || code.toUpperCase();
                    window.showMessage('success', `Promo applied: -₹${discountAmount.toFixed(2)}`);
                    initSummary();
                } catch (error) {
                    window.showMessage('error', 'Failed to apply promo');
                }
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!window.isLoggedIn()) {
                    window.showMessage('error', 'Please log in to continue.');
                    return;
                }

                const btn = document.getElementById('place-order-btn');
                btn.disabled = true;
                btn.textContent = 'Processing...';

                const subtotal = cart.reduce((sum, item) => sum + (Number(item.price) || 0) * (item.qty || item.quantity || 1), 0);
                const tax = subtotal * 0.18;
                const total = subtotal + tax - discountAmount;

                const orderData = {
                    orderItems: cart.map(item => ({
                        name: item.name,
                        qty: item.qty || item.quantity || 1,
                        image: item.image || item.imageUrl || (item.images && item.images[0]),
                        price: item.price,
                        product: item._id || item.id
                    })),
                    shippingAddress: {
                        address: document.getElementById('address').value,
                        city: document.getElementById('city').value,
                        state: document.getElementById('state').value,
                        postalCode: document.getElementById('zip').value,
                        country: 'India',
                        phone: document.getElementById('phone').value,
                        company: document.getElementById('company').value,
                        gstin: document.getElementById('gstin').value
                    },
                    paymentMethod: 'COD',
                    itemsPrice: subtotal,
                    taxPrice: tax,
                    shippingPrice: 0,
                    totalPrice: total,
                    promoCode: activePromoCode,
                    discountAmount: discountAmount,
                    deliverySlot: document.getElementById('delivery-slot').value,
                    orderNotes: document.getElementById('order-notes').value,
                    giftMessage: document.getElementById('gift-message').value
                };

                if (saveAddress && saveAddress.checked) {
                    try {
                        await fetch(`${window.API_BASE_URL}/users/addresses`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${window.getAuthToken()}`
                            },
                            body: JSON.stringify({
                                label: 'Saved',
                                address: orderData.shippingAddress.address,
                                city: orderData.shippingAddress.city,
                                state: orderData.shippingAddress.state,
                                postalCode: orderData.shippingAddress.postalCode,
                                country: orderData.shippingAddress.country,
                                phone: orderData.shippingAddress.phone,
                                company: orderData.shippingAddress.company,
                                gstin: orderData.shippingAddress.gstin,
                                isDefault: false
                            })
                        });
                    } catch (error) {
                        console.error('Failed to save address:', error);
                    }
                }

                try {
                    const response = await fetch(`${window.API_BASE_URL}/orders`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${window.getAuthToken()}`
                        },
                        body: JSON.stringify(orderData)
                    });

                    let payload = null;
                    try {
                        payload = await response.json();
                    } catch (parseErr) {
                        payload = null;
                    }

                    if (response.ok) {
                        window.saveCart([]);
                        document.getElementById('success-modal').classList.remove('hidden');
                        return;
                    }

                    const serverMessage = payload && payload.message ? payload.message : 'Order processing failed';
                    if (response.status === 401 || response.status === 403) {
                        window.showMessage('error', 'Please log in to continue.');
                        setTimeout(() => {
                            window.location.href = 'login.html?redirect=checkout.html';
                        }, 800);
                        return;
                    }

                    throw new Error(serverMessage);
                } catch (err) {
                    window.showMessage('error', err.message || 'Order processing failed');
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Authorize Checkout';
                }
            });

            initSummary();
            loadAddresses();
            if (window.lucide) lucide.createIcons();
        });
    </script>
</body>

</html>