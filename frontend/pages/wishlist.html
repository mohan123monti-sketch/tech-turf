<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tech Turf - Wishlist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="/src/css/pages/style.css">
    <link rel="stylesheet" href="/src/css/pages/shop-styles.css">
    <script src="/src/js/features/shop-logic.js"></script>
    <script src="/src/js/core/layout.js" defer></script>
</head>

<body data-page="Wishlist" class="shop-branding">
    <div id="header-container"></div>

    <main class="relative z-10 py-28 px-4 min-h-screen">
        <div class="max-w-6xl mx-auto">
            <header class="mb-10 reveal-hidden">
                <h1 class="text-4xl md:text-6xl font-black tracking-tighter text-white uppercase leading-none">
                    Wishlist
                </h1>
                <p class="text-[10px] font-black tracking-[0.4em] uppercase text-white/40 mt-3">
                    Saved Items
                </p>
                <div class="mt-6 flex flex-wrap gap-3">
                    <button id="share-wishlist"
                        class="px-6 py-3 bg-white/10 border border-white/10 rounded-xl text-xs text-white/80 uppercase tracking-widest hover:bg-white/20 transition-all">
                        Share Wishlist
                    </button>
                </div>
            </header>

            <div id="wishlist-grid" class="product-grid"></div>
        </div>
    </main>

    <div id="footer-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const grid = document.getElementById('wishlist-grid');

            const allProducts = await window.fetchProducts();
            const urlParams = new URLSearchParams(window.location.search);
            const sharedIds = urlParams.get('ids');
            const wishlistIds = new Set(
                sharedIds ? sharedIds.split(',').filter(Boolean) : (window.getWishlistIds ? window.getWishlistIds() : [])
            );

            const wishlistProducts = allProducts.filter((product) => {
                const id = product._id || product.id;
                return id && wishlistIds.has(String(id));
            });

            if (wishlistProducts.length === 0) {
                grid.innerHTML = `
                    <div class="iphone-glass p-12 rounded-[2.5rem] border border-white/5 text-center col-span-full">
                        <i data-lucide="heart" class="w-12 h-12 text-white/20 mx-auto mb-6"></i>
                        <h2 class="text-xl font-black text-white uppercase tracking-widest">Wishlist Empty</h2>
                        <p class="text-white/30 text-xs uppercase tracking-widest mt-3">Browse products and tap the heart to save.</p>
                        <a href="shopping.html" class="inline-block mt-8 px-8 py-3 bg-white text-black font-black text-xs uppercase tracking-widest rounded-xl hover:bg-gray-200 transition-all">Shop Now</a>
                    </div>
                `;
                if (window.lucide) lucide.createIcons();
                return;
            }

            const renderCard = (product) => {
                const stock = Number(product.stock || product.countInStock || 0);
                const productId = product._id || product.id;
                return `
                    <div class="product-card group relative bg-white/5 border border-white/10 rounded-2xl overflow-hidden hover:border-[#d2670e]/50 transition-all duration-300">
                        <button class="remove-wishlist absolute top-3 right-3 w-10 h-10 rounded-full border border-red-400/40 bg-black/40 text-red-400 flex items-center justify-center" data-product-id="${productId}">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                        <div class="aspect-square bg-black/20 relative overflow-hidden">
                            <img src="${product.imageUrl || (product.images && product.images[0]) || 'https://via.placeholder.com/300'}" alt="${product.name}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                        </div>
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-white font-bold text-lg leading-tight group-hover:text-[#d2670e] transition-colors">${product.name}</h3>
                                <span class="text-[#d2670e] font-mono font-bold">â‚¹${product.price}</span>
                            </div>
                            <p class="text-gray-400 text-sm line-clamp-2 mb-4">${product.description}</p>
                            <div class="flex items-center gap-2 text-xs text-gray-500 font-mono mb-4">
                                <span class="w-2 h-2 rounded-full ${stock > 0 ? 'bg-green-500' : 'bg-red-500'}"></span>
                                ${stock > 0 ? `In Stock (${stock})` : 'Out of Stock'}
                            </div>
                            <button class="add-to-cart-btn w-full px-4 py-3 rounded-xl text-xs font-black uppercase tracking-widest ${stock > 0 ? 'bg-[#d2670e] hover:bg-[#b0550b] text-white' : 'bg-white/10 text-white/40 cursor-not-allowed'}" ${stock > 0 ? '' : 'disabled'} data-product-id="${productId}">
                                ${stock > 0 ? 'Add to Cart' : 'Out of Stock'}
                            </button>
                        </div>
                    </div>
                `;
            };

            grid.innerHTML = wishlistProducts.map(renderCard).join('');
            if (window.lucide) lucide.createIcons();

            const shareBtn = document.getElementById('share-wishlist');
            if (shareBtn) {
                shareBtn.addEventListener('click', async () => {
                    const ids = Array.from(wishlistIds);
                    if (ids.length === 0) {
                        window.showMessage('info', 'Your wishlist is empty.');
                        return;
                    }
                    const shareUrl = `${window.location.origin}${window.location.pathname}?ids=${ids.join(',')}`;
                    try {
                        await navigator.clipboard.writeText(shareUrl);
                        window.showMessage('success', 'Wishlist link copied.');
                    } catch (error) {
                        window.showMessage('info', shareUrl);
                    }
                });
            }

            grid.addEventListener('click', (event) => {
                const removeBtn = event.target.closest('.remove-wishlist');
                const addBtn = event.target.closest('.add-to-cart-btn');

                if (removeBtn) {
                    const productId = removeBtn.dataset.productId;
                    wishlistIds.delete(String(productId));
                    localStorage.setItem('tt_wishlist', JSON.stringify(Array.from(wishlistIds)));
                    if (window.updateWishlistDisplay) window.updateWishlistDisplay();
                    removeBtn.closest('.product-card').remove();
                    if (!grid.querySelector('.product-card')) {
                        window.location.reload();
                    }
                }

                if (addBtn) {
                    const productId = addBtn.dataset.productId;
                    const product = allProducts.find(p => String(p._id || p.id) === String(productId));
                    if (product) {
                        window.addToCart(product);
                    }
                }
            });
        });
    </script>
</body>

</html>
