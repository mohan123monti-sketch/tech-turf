<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tech Turf - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link rel="stylesheet" href="/src/css/pages/style.css">
    <link rel="stylesheet" href="admin.css">
    <script src="admin-layout.js" defer></script>
    <script src="/src/js/ai/nexus-ai.js" defer></script>
</head>

<body data-3d-enabled="true" class="text-white font-sans antialiased overflow-hidden">
    <!-- 3D Background -->
    <div id="three-container" class="fixed inset-0 -z-50"></div>

    <div id="app-container" class="flex h-screen overflow-hidden relative z-10">
        <aside id="sidebar-container" class="w-64 iphone-glass border-r border-white/5 hidden md:flex flex-col"></aside>
        <div class="flex-1 flex flex-col overflow-hidden">
            <header id="topbar-container"
                class="h-16 iphone-glass border-b border-white/5 flex items-center justify-between px-6"></header>
            <main class="flex-1 overflow-x-hidden overflow-y-auto p-6">
                <!-- Dashboard Grid -->
                <div id="dashboard-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Stats Cards -->
                    <div class="iphone-glass rounded-2xl p-6 border border-white/5 hover:border-white/10 transition-all">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-400 text-sm font-bold">Total Orders</h3>
                            <i data-lucide="shopping-cart" class="w-5 h-5 text-orange-500"></i>
                        </div>
                        <p class="text-3xl font-black text-white" id="stat-orders">0</p>
                        <p class="text-xs text-gray-500 mt-2">Orders in system</p>
                    </div>

                    <div class="iphone-glass rounded-2xl p-6 border border-white/5 hover:border-white/10 transition-all">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-400 text-sm font-bold">Total Revenue</h3>
                            <i data-lucide="dollar-sign" class="w-5 h-5 text-green-500"></i>
                        </div>
                        <p class="text-3xl font-black text-white" id="stat-revenue">₹0</p>
                        <p class="text-xs text-gray-500 mt-2">Total sales</p>
                    </div>

                    <div class="iphone-glass rounded-2xl p-6 border border-white/5 hover:border-white/10 transition-all">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-400 text-sm font-bold">Products</h3>
                            <i data-lucide="package" class="w-5 h-5 text-blue-500"></i>
                        </div>
                        <p class="text-3xl font-black text-white" id="stat-products">0</p>
                        <p class="text-xs text-gray-500 mt-2">Total products</p>
                    </div>

                    <div class="iphone-glass rounded-2xl p-6 border border-white/5 hover:border-white/10 transition-all">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-400 text-sm font-bold">Users</h3>
                            <i data-lucide="users" class="w-5 h-5 text-purple-500"></i>
                        </div>
                        <p class="text-3xl font-black text-white" id="stat-users">0</p>
                        <p class="text-xs text-gray-500 mt-2">Registered users</p>
                    </div>
                </div>

                <!-- Recent Orders Table -->
                <div class="iphone-glass rounded-[2rem] border border-white/5 overflow-hidden">
                    <div class="p-6 border-b border-white/5">
                        <h2 class="text-xl font-black text-white">Recent Orders</h2>
                    </div>
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="iphone-glass text-white/50 text-[10px] uppercase tracking-[0.2em]">
                                <th class="p-6 font-bold">Order ID</th>
                                <th class="p-6 font-bold">Customer</th>
                                <th class="p-6 font-bold">Date</th>
                                <th class="p-6 font-bold">Total</th>
                                <th class="p-6 font-bold">Status</th>
                                <th class="p-6 font-bold text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recent-orders-tbody" class="divide-y divide-white/5">
                            <tr>
                                <td colspan="6" class="p-6 text-center text-gray-500">Loading orders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Admin Dashboard Init
        const API_BASE_URL = '/api';

        async function loadDashboardStats() {
            const token = localStorage.getItem('tt_token');
            if (!token) {
                window.location.href = '../login.html';
                return;
            }

            try {
                // Load orders
                const ordersRes = await fetch(`${API_BASE_URL}/orders`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const orders = await ordersRes.ok ? await ordersRes.json() : [];

                // Load products
                const productsRes = await fetch(`${API_BASE_URL}/products`);
                const products = await productsRes.ok ? await productsRes.json() : [];

                // Load users
                const usersRes = await fetch(`${API_BASE_URL}/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const users = await usersRes.ok ? await usersRes.json() : [];

                // Update stats
                document.getElementById('stat-orders').textContent = Array.isArray(orders) ? orders.length : 0;
                document.getElementById('stat-products').textContent = Array.isArray(products) ? products.length : 0;
                document.getElementById('stat-users').textContent = Array.isArray(users) ? users.length : 0;

                // Calculate total revenue
                const totalRevenue = Array.isArray(orders) ?
                    orders.reduce((sum, order) => sum + (order.totalPrice || 0), 0) : 0;
                document.getElementById('stat-revenue').textContent = `₹${totalRevenue.toFixed(0)}`;

                // Render recent orders
                renderRecentOrders(orders);

            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        function renderRecentOrders(orders) {
            const tbody = document.getElementById('recent-orders-tbody');
            if (!Array.isArray(orders) || orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-gray-500">No orders found.</td></tr>';
                return;
            }

            const statusColors = {
                'Pending': 'bg-yellow-500/10 text-yellow-500',
                'Processing': 'bg-blue-500/10 text-blue-500',
                'Shipped': 'bg-indigo-500/10 text-indigo-500',
                'Delivered': 'bg-green-500/10 text-green-500',
                'Cancelled': 'bg-red-500/10 text-red-500'
            };

            tbody.innerHTML = orders.slice(0, 5).map(order => {
                const displayStatus = order.status || (order.isDelivered ? 'Delivered' : 'Pending');
                return `
                    <tr class="hover:bg-white/5 transition-colors">
                        <td class="p-6 font-mono text-gray-400">#${order._id.slice(-6).toUpperCase()}</td>
                        <td class="p-6">
                            <div class="font-medium">${order.user?.username || 'Guest'}</div>
                            <div class="text-xs text-gray-500">${order.user?.email || 'N/A'}</div>
                        </td>
                        <td class="p-6 text-gray-400">${new Date(order.createdAt).toLocaleDateString()}</td>
                        <td class="p-6 font-bold">₹${Number(order.totalPrice || 0).toFixed(2)}</td>
                        <td class="p-6">
                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusColors[displayStatus] || statusColors['Pending']}">
                                ${displayStatus}
                            </span>
                        </td>
                        <td class="p-6 text-right">
                            <a href="orders.html?id=${order._id}" class="text-blue-400 hover:text-blue-300 text-sm font-medium">View</a>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardStats();
        });
    </script>
</body>

</html>
