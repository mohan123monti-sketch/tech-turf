<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tech Turf - Secure Checkout</title>

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Our New Centralized Files -->
    <link rel="stylesheet" href="style.css">
    <script src="layout.js" defer></script>

    <!-- Page-Specific Styles -->
    <style>
        body {
            background-color: #f7f9fb;
            color: #1f2937;
        }

        .light-card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
            box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.05);
        }

        .light-input {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            color: #1f2937;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }

        .light-input:focus {
            border-color: #fb923c;
            background-color: #ffffff;
            box-shadow: 0 0 0 1px #fb923c;
            outline: none;
        }
    </style>
</head>

<body data-page="Checkout" data-3d-enabled="false" class="bg-gray-100 text-gray-900">

    <div id="header-container"></div>

    <main class="relative z-10 py-24 sm:py-32 px-4">
        <div class="max-w-7xl mx-auto">

            <div class="text-center mb-16">
                <h1 class="text-5xl md:text-6xl font-extrabold text-gray-900 mb-6">
                    Secure Checkout
                </h1>
                <p class="text-xl md:text-2xl text-gray-600 max-w-3xl mx-auto">
                    You're just one step away from completing your purchase.
                </p>
            </div>

            <form id="checkout-form">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                    <!-- Form (Shipping & Payment) -->
                    <div class="lg:col-span-2 space-y-8">

                        <!-- Shipping Details -->
                        <div class="light-card p-8">
                            <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4">Shipping Information</h2>
                            <div class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="first-name"
                                            class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                                        <input type="text" id="first-name" name="first-name" required
                                            class="w-full light-input px-4 py-3 shipping-field">
                                    </div>
                                    <div>
                                        <label for="last-name" class="block text-sm font-medium text-gray-700 mb-2">Last
                                            Name</label>
                                        <input type="text" id="last-name" name="last-name" required
                                            class="w-full light-input px-4 py-3 shipping-field">
                                    </div>
                                </div>
                                <div>
                                    <label for="email-checkout"
                                        class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input type="email" id="email-checkout" name="email-checkout" required
                                        class="w-full light-input px-4 py-3 shipping-field">
                                </div>
                                <div>
                                    <label for="address"
                                        class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                                    <input type="text" id="address" name="address" required
                                        class="w-full light-input px-4 py-3 shipping-field">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <label for="city"
                                            class="block text-sm font-medium text-gray-700 mb-2">City</label>
                                        <input type="text" id="city" name="city" required
                                            class="w-full light-input px-4 py-3 shipping-field">
                                    </div>
                                    <div>
                                        <label for="state" class="block text-sm font-medium text-gray-700 mb-2">State /
                                            Province</label>
                                        <input type="text" id="state" name="state" required
                                            class="w-full light-input px-4 py-3 shipping-field">
                                    </div>
                                    <div>
                                        <label for="zip" class="block text-sm font-medium text-gray-700 mb-2">Zip /
                                            Postal Code</label>
                                        <input type="text" id="zip" name="zip" required
                                            class="w-full light-input px-4 py-3 shipping-field">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Details -->
                        <div class="light-card p-8">
                            <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4">Payment Information</h2>
                            <div class="space-y-6">
                                <div>
                                    <label for="card-number" class="block text-sm font-medium text-gray-700 mb-2">Card
                                        Number</label>
                                    <input type="text" id="card-number" name="card-number"
                                        placeholder="**** **** **** ****" required
                                        class="w-full light-input px-4 py-3 payment-field">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <label for="exp-date"
                                            class="block text-sm font-medium text-gray-700 mb-2">Expiration
                                            (MM/YY)</label>
                                        <input type="text" id="exp-date" name="exp-date" placeholder="MM/YY" required
                                            class="w-full light-input px-4 py-3 payment-field">
                                    </div>
                                    <div>
                                        <label for="cvc"
                                            class="block text-sm font-medium text-gray-700 mb-2">CVC</label>
                                        <input type="text" id="cvc" name="cvc" placeholder="***" required
                                            class="w-full light-input px-4 py-3 payment-field">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="lg:col-span-1">
                        <div class="light-card p-8 sticky top-24">
                            <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4">Order Summary</h2>
                            <div id="order-items-summary" class="space-y-4 mb-6">
                                <!-- Items injected here -->
                            </div>
                            <div class="border-t border-gray-200 pt-6">
                                <div class="flex justify-between text-xl font-bold mb-6">
                                    <span>Total (USD)</span>
                                    <span id="order-total-display">$0.00</span>
                                </div>
                                <button id="place-order-btn" type="submit"
                                    class="w-full btn-primary inline-flex items-center justify-center px-8 py-4 border border-transparent text-lg font-medium rounded-lg text-white bg-orange-600 hover:bg-orange-700 shadow-lg hover:shadow-orange-500/50 transition-all duration-300">
                                    <i data-lucide="lock" class="w-5 h-5 mr-2"></i>
                                    Place Order & Pay
                                </button>
                                <p class="text-xs text-gray-500 text-center mt-4">
                                    Secure payment processed by Stripe.
                                </p>
                            </div>
                        </div>
                    </div>

                </div>
            </form>
        </div>
    </main>

    <!-- Success Modal -->
    <div id="success-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm hidden">
        <div class="light-card max-w-sm w-full p-8 m-4 rounded-2xl text-center transform transition-all scale-95 opacity-0"
            style="--tw-scale-x: .95; --tw-scale-y: .95; --tw-opacity: 0; transition: transform 0.3s ease-out, opacity 0.3s ease-out;">
            <div
                class="w-16 h-16 rounded-full bg-green-100 flex items-center justify-center mb-6 border border-green-300 mx-auto">
                <i data-lucide="check-circle" class="w-10 h-10 text-green-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-4">Payment Successful!</h3>
            <p class="text-gray-600 mb-6">
                Your order has been placed successfully.
            </p>
            <a href="index.html"
                class="w-full btn-secondary inline-flex items-center justify-center px-6 py-2 border border-transparent text-base font-medium rounded-lg text-white bg-gray-800 hover:bg-gray-900 shadow-lg transition-all duration-300">
                Back to Home
            </a>
        </div>
    </div>

    <div id="footer-container"></div>

    <script>
        window.addEventListener('load', () => {
            const form = document.getElementById('checkout-form');
            const modal = document.getElementById('success-modal');
            const modalContent = modal.querySelector('.light-card');
            const placeOrderBtn = document.getElementById('place-order-btn');

            function checkLayoutReady() {
                if (typeof window.getCart === 'function' && typeof window.showMessage === 'function') {
                    initCheckout();
                } else {
                    setTimeout(checkLayoutReady, 50);
                }
            }

            function initCheckout() {
                const cart = window.getCart();
                if (cart.length === 0) {
                    window.location.href = 'shopping.html';
                    return;
                }

                // Render Summary
                const summaryContainer = document.getElementById('order-items-summary');
                let subtotal = 0;
                cart.forEach(item => {
                    subtotal += item.price;
                    const el = document.createElement('div');
                    el.className = 'flex justify-between';
                    el.innerHTML = `
                        <span class="text-gray-600">${item.name} (x1)</span>
                        <span class="font-medium">$${item.price.toFixed(2)}</span>
                    `;
                    summaryContainer.appendChild(el);
                });

                const tax = subtotal * 0.08;
                const total = subtotal + tax;

                // Add tax line
                const taxEl = document.createElement('div');
                taxEl.className = 'flex justify-between border-t border-gray-100 pt-2 mt-2';
                taxEl.innerHTML = `
                    <span class="text-gray-600">Tax</span>
                    <span class="font-medium">$${tax.toFixed(2)}</span>
                `;
                summaryContainer.appendChild(taxEl);

                document.getElementById('order-total-display').textContent = `$${total.toFixed(2)}`;

                // Handle Submit
                form.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    if (!window.isLoggedIn()) {
                        window.showMessage('error', 'Please log in to complete your purchase.');
                        setTimeout(() => window.location.href = 'login.html', 1500);
                        return;
                    }

                    // Validation
                    let isValid = true;
                    document.querySelectorAll('.shipping-field, .payment-field').forEach(field => {
                        if (!field.value) {
                            isValid = false;
                            field.classList.add('border-red-500');
                        } else {
                            field.classList.remove('border-red-500');
                        }
                    });

                    if (!isValid) {
                        window.showMessage('error', 'Please fill in all required fields.');
                        return;
                    }

                    placeOrderBtn.disabled = true;
                    placeOrderBtn.innerHTML = '<i data-lucide="loader" class="animate-spin w-5 h-5 mr-2"></i> Processing...';
                    lucide.createIcons();

                    // Prepare Order Data
                    const orderData = {
                        orderItems: cart.map(item => ({
                            name: item.name,
                            qty: 1,
                            image: item.imageUrl,
                            price: item.price,
                            product: '000000000000000000000000' // Placeholder ID if we don't have real IDs in cart yet
                        })),
                        shippingAddress: {
                            address: document.getElementById('address').value,
                            city: document.getElementById('city').value,
                            postalCode: document.getElementById('zip').value,
                            country: 'USA' // Defaulting for now
                        },
                        paymentMethod: 'Card',
                        itemsPrice: subtotal,
                        taxPrice: tax,
                        shippingPrice: 0,
                        totalPrice: total
                    };

                    try {
                        const token = window.getAuthToken();
                        const response = await fetch(`${window.API_BASE_URL}/orders`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(orderData)
                        });

                        if (!response.ok) throw new Error('Order failed');

                        // Success
                        window.saveCart([]); // Clear cart

                        modal.classList.remove('hidden');
                        setTimeout(() => {
                            modalContent.style.transform = 'scale(1)';
                            modalContent.style.opacity = '1';
                        }, 10);

                    } catch (err) {
                        console.error(err);
                        window.showMessage('error', 'Failed to place order. Please try again.');
                        placeOrderBtn.disabled = false;
                        placeOrderBtn.innerHTML = 'Place Order & Pay';
                    }
                });
            }

            checkLayoutReady();
        });
    </script>
</body>

</html>